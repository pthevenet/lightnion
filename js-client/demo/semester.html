<html>

<head>
    <script src="signature.js"></script>
    <script src="path.js"></script>
    <script src="parser.js"></script>
    <script src="consensusParser.js"></script>
    <script src="http://peterolson.github.com/BigInteger.js/BigInteger.min.js"></script>
    <script src="lightnion.bundle.js"></script>
    <meta charset="UTF-8">
</head>

<p id="loaded"></p>
<button id="button" , type="button">Get Consensus</button>
<pre id="log"></pre>

<body>
    <script>

        let button = document.getElementById("button")
        let cons_raw = ""
        let des_raw = ""
        let des = null
        let cons = null
        let end = null
        button.addEventListener("click", get_consensus_listener)


        function get_consensus_listener() {
            lnn.open('localhost', 4990,
                function success(endpoint) {
                    if (endpoint.state != lnn.state.success)
                        return
                    
                    end = endpoint
                    document.getElementById('loaded').innerHTML = '(channel opened)'


                    lnn.stream.dir(endpoint, "/tor/status-vote/current/consensus", handler_consensus)
                },
                function error(endpoint) {
                    document.getElementById('loaded').innerHTML = '(unable to open)'
                })
        }

        function verify_listener() {

            if (signature.verify(cons_raw, keys, 0.5)) {
                document.getElementById("log").textContent = "Consensus has been verified succesfully"
                lnn.stream.dir(end, "/tor/server/all", handler_descriptor)
            } else {
                document.getElementById("log").textContent = "Consensus has not been verified"
            }

        }

        function select_path_listener(){
            let [guard, middle, exit] = path.select(cons, des, true)
            document.getElementById('log').textContent = "Exit: " + exit['router'].nickname+"\n"
            document.getElementById('log').textContent += "Guard: " + guard['router'].nickname+"\n"
            document.getElementById('log').textContent += "Middle: " + middle['router'].nickname
        }

        function parser_listener(){
            let cons_parser = new ConsensusParser(cons_raw)
            cons = cons_parser.parse()
            des = parser.descriptors.parse(des_raw)
    

            document.getElementById("log").textContent = JSON.stringify(cons, undefined, '\t')

            button.removeEventListener("click", parser_listener)
            button.textContent = "Select a path"
            button.addEventListener("click", select_path_listener)
        }

        function handler_consensus(request) {
            if (request.state == lnn.state.success) {
                document.getElementById('log').innerHTML += request.data
                cons_raw += request.data
                if (request.cell.cmd == "end") {

                    let idx = cons_raw.indexOf("network-status-version")
                    cons_raw = cons_raw.substring(idx)

                    button.removeEventListener("click", get_consensus_listener)
                    button.textContent = "Verify"
                    button.addEventListener("click", verify_listener)
                }
            }
        }

        function handler_descriptor(request){
            if (request.state == lnn.state.success) {
                des_raw += request.data
                if (request.cell.cmd == "end") {
                    let idx = des_raw.indexOf("router")
                    des_raw = des_raw.substring(idx)

                    button.removeEventListener("click", verify_listener)
                    button.textContent = "Parse"
                    button.addEventListener("click", parser_listener)
                }
            }
        }

        function read_text_file(path, success) {
            let rq = new XMLHttpRequest();
            rq.open("GET", path, false);
            rq.onreadystatechange = function () {
                if (rq.readyState === XMLHttpRequest.DONE) {
                    if (rq.status === 200 || rq.status == 0) {
                        let text = rq.responseText
                        success(text)
                    } else {
                        console.log(rq.status)
                    }
                }
            }
            rq.send(null);
        }

        var keys = {"7747E801F1EFE005A35325D6C467D383E347BF2E": {"pem": "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEA3R8UV8hyywOC6/aVhTIS1woqCC1GKksS30zcLQ3+lzbuMn0v41HU\nEbiNOPgsuEkZwH9GVCJdJirsvrgGQ8qNmm8FoHSkviNuFH+VKCV7/wAFq2zIPGmk\neo6Ck3HRULFfOz5blLfqUQyCxA4XnEWo6cNvVbxY4foZ64cFkTBlYzYGdGkaxwmt\nC7JubdVoJKS6yuzCAERQdGQ6ZDsgpUhb4bSRgNTAytLHU8r8xa5BGmJqu5eN28HL\nkl1JxuqAy47YT/gWPvlq5O0rAdJCERMk+Z7qVMQT7v64bnDg88FEtTmSLgZZQVsl\n1KWTEX4eXDvZtY2ivglCFNAVxYNo22vVHwIDAQAB\n-----END RSA PUBLIC KEY-----", "modulus": "27913991252627761010157412513595678584231011774092863758023690938783788457300781496501965258171478891213132642920788909749101269920547236080200108680929993999811958890300617283019073950906484520036158770187087302021041568861453996110057153107239903173521773549730982883583888746086411660669356940136341225913766117113212597798371313686103378601305697077579662049149236498341307682000549698406798662524718582138844570637230089545000377655605617001556051320309130622048592720561799634603479495640852266334689961113236607631261120997502445132233593158063337410542908352953122701605378814975107383791482329025239218640159", "exponent": "65537"}, "0DB972D942C9403069FF89B6608F9B933952FD4D": {"pem": "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAyzufHWJjDi3bOqwdOnkQ06sivp0L3ZEObPvqzQsm4IYhONz3TjGf\nUVb/k1e5LJQ8iNmKw7HyiY02Xc1rxZIHtk4JX8ndNmq29LwnS/Fn4EI0EHc/NWPg\nUfDOgxUkoHfuZpAL140C7EaL5eg7u9KmPX00mziWHXEex3liYWDFecicnV1BTbRt\nsXbE0qSQlKQ8O+heoO3X7f2zjNRTkbhYLw1PqmxvHGToKGjjMjRPgBwgoRBcUSIQ\nwb4fcNuL78EwtvV+qCDGPKBydWHOgJ11KmJZeQY2GPRm6n8Q70iVBJR8wEqNyZfp\njOOkHvs2t7fxkTvREdbZgLQ6f00RJCe2QQIDAQAB\n-----END RSA PUBLIC KEY-----", "modulus": "25655776386299706653807640973973226420230438609945596347099875217962325453485980820232561637193650836733862630948375800510842364127169043879918406311901764912197749472739000384121094190284135597552156852978407112032615043354261752254168193852786520554031015461602977784740140289029346178616518322317713150382217587395281686771008898917227961366635966999821663230423597454871156384538696763428549151719839081081727689317849312501102698502227834364434002317777246499274211642892852778983346793261437022979081660699774347505692646046228335332804674810251230272588014903861900704396954703349558687332846833812294670464577", "exponent": "65537"}, "FBC631759B4B8F1B78C697239B684B8A5F36B7DD": {"pem": "-----BEGIN RSA PUBLIC KEY-----\nMIIBCgKCAQEAwbFzaf/vlrRrnpE03r+AU+FLtkAljn7hXM1zSxrE8TzJwWcPa2lw\nP523nUr1zznzrSe8kUpNyoRudduCCBo93QYm7/PBlrFQlmvcKsCeF2Ke784qKnot\nHL4bHrIyoX/aOI1/+h0ReYXw0eB+btxNUCppHmlr4VnNAbD5/CQgkumrkp3oFv0F\nZTVV3U7pWfCjE4o9XdSLsRbNC2uUSiEeZgvRAfs2+xxdKWdTdaoBGNYWc+VUnHS/\nkaYymQ1EgJsAM2fCqELPjxCGotsSVHz7NJGVlVt7190O3vj1NOzhYVNirvgtw6yZ\nakiHQSnUiiTXsVuTnm0jCcYInMZIxZNM8wIDAQAB\n-----END RSA PUBLIC KEY-----", "modulus": "24451497127097351969514883591790412207726923166257753190121513764287165601086476509952790920065924960006785689827410252544315552877197159842372692522677510345646324209252134610918618429481021165185489180978438335290517154675523931252333314616185530123737124504065361536157672441102280440970584546454016834009401435727510803067443111102811980042053464883504773453510738094043934021926065017094498929313753330329684271139220152154524340354546990433446935433576878284556534285023023253647201510154934872606275080606428864383928915678708944325190595580146230255946273214280514567578063252622839981548772735186034538794227", "exponent": "65537"}}
        </script>
</body>

</html>