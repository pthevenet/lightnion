<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Websocket Redirection</title>
    <link rel="stylesheet" href="../ws_style.css">
    <!-- TLS/HTTP library -->
    <script src="../jquery.min.js"></script>
    <script src="../forge.all.js"></script>

    <script>
        window._WebSocket = WebSocket;
    </script>
    <!-- lightnion client -->
    <script src='../lightnion.bundle.js'></script>

    <script type="module">
        import LWS from "../custom-websocket/lws.js"
        console.log("overriding websockets");
        // redefining websockets
        window._WebSocket = WebSocket;
        WebSocket = LWS;

        // problem: lightnion.bundle.js must use websocket
    </script>

</head>

<body onload="focus()">
    <h1>Websocket Redirection</h1>

    <ul id="messages"></ul>
    <form id="echo-form" action="javascript:void(0);">
        <input id="echo-input" autocomplete="off" />
        <button type="button" id="echo-button" onclick="sendMessage()">Send</button>
    </form>

    <script>
        // send message in input through websocket
        function sendMessage() {
            let msg = document.getElementById("echo-input").value;
            document.getElementById("echo-input").value = "";
            appendMessage(msg);
            window.ws.send(lnn.dec.utf8(msg));
        }

        // add a message to the frontend
        function appendMessage(msg) {
            var ul = document.getElementById("messages");
            var li = document.createElement("li");
            li.appendChild(document.createTextNode(msg));
            ul.appendChild(li);
        }
    </script>
    <script defer type="module">

        // create websocket as normal
        let url = new URL("ws://demos.kaazing.com/echo");
        let ws = new WebSocket(url);

        ws.onMessage = (data) => {
            let text = lnn.enc.utf8(data);
            console.log("REKRKERE")
            appendMessage(text);
        }

        window.ws = ws;

    </script>

</body>

</html>